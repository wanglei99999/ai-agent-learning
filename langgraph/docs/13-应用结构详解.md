# 应用结构详解

> LangGraph 应用的标准目录结构和配置文件说明

LangGraph 应用由以下部分组成：

| 组件 | 说明 |
|------|------|
| **图 (Graphs)** | 一个或多个实现应用逻辑的图 |
| **配置文件** | `langgraph.json` 指定依赖、图、环境变量 |
| **依赖文件** | `requirements.txt` 或 `pyproject.toml` |
| **环境变量** | `.env` 文件（可选） |

## 目录结构

### 使用 requirements.txt

```
my-app/
├── my_agent/                # 项目代码目录
│   ├── utils/               # 工具模块
│   │   ├── __init__.py
│   │   ├── tools.py         # 工具定义
│   │   ├── nodes.py         # 节点函数
│   │   └── state.py         # 状态定义
│   ├── __init__.py
│   └── agent.py             # 图构建代码
├── .env                     # 环境变量
├── requirements.txt         # 依赖包
└── langgraph.json           # LangGraph 配置文件
```

### 使用 pyproject.toml

```
my-app/
├── my_agent/                # 项目代码目录
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── tools.py
│   │   ├── nodes.py
│   │   └── state.py
│   ├── __init__.py
│   └── agent.py
├── .env                     # 环境变量
├── langgraph.json           # LangGraph 配置文件
└── pyproject.toml           # 依赖配置
```

## 配置文件 (langgraph.json)

`langgraph.json` 是 JSON 格式的配置文件，指定依赖、图、环境变量等部署所需的设置。

### 基本结构

```json
{
  "dependencies": ["langchain_openai", "./your_package"],
  "graphs": {
    "my_agent": "./your_package/your_file.py:agent"
  },
  "env": "./.env"
}
```

### 配置项说明

| 键 | 说明 |
|-----|------|
| `dependencies` | 依赖包列表，支持 PyPI 包和本地包路径 |
| `graphs` | 图定义，键为图名称，值为图的路径 |
| `env` | 环境变量文件路径 |
| `dockerfile_lines` | 额外的系统依赖或二进制文件（可选） |

### 图路径格式

```
./your_package/your_file.py:variable
```

- `./your_package/your_file.py`：Python 文件路径
- `variable`：文件中的图变量名或返回图的函数名

### 示例配置

```json
{
  "dependencies": [
    "langchain_openai",
    "langchain_anthropic",
    "./my_agent"
  ],
  "graphs": {
    "chat_agent": "./my_agent/agent.py:graph",
    "research_agent": "./my_agent/research.py:create_graph"
  },
  "env": "./.env"
}
```

## 依赖管理

### requirements.txt 方式

```txt
langgraph>=0.2.0
langchain-openai>=0.1.0
python-dotenv>=1.0.0
```

配置文件中引用：

```json
{
  "dependencies": ["./"]
}
```

### pyproject.toml 方式

```toml
[project]
name = "my-agent"
version = "0.1.0"
dependencies = [
    "langgraph>=0.2.0",
    "langchain-openai>=0.1.0",
    "python-dotenv>=1.0.0",
]
```

配置文件中引用：

```json
{
  "dependencies": ["./"]
}
```

### 混合依赖

可以同时指定 PyPI 包和本地包：

```json
{
  "dependencies": [
    "langchain_openai",      // PyPI 包
    "./my_agent",            // 本地包
    "./shared_utils"         // 另一个本地包
  ]
}
```

## 图定义

### 单个图

```json
{
  "graphs": {
    "my_agent": "./my_agent/agent.py:graph"
  }
}
```

### 多个图

```json
{
  "graphs": {
    "chat_agent": "./my_agent/chat.py:graph",
    "research_agent": "./my_agent/research.py:graph",
    "code_agent": "./my_agent/code.py:create_graph"
  }
}
```

### 图变量 vs 图函数

```python
# agent.py

# 方式 1：直接导出编译后的图
graph = builder.compile()

# 方式 2：导出返回图的函数
def create_graph():
    builder = StateGraph(State)
    # ... 构建图
    return builder.compile()
```

配置文件中：
```json
{
  "graphs": {
    "agent_1": "./agent.py:graph",        // 直接引用变量
    "agent_2": "./agent.py:create_graph"  // 引用函数
  }
}
```

## 环境变量

### 本地开发

使用 `.env` 文件：

```env
OPENAI_API_KEY=sk-xxx
ANTHROPIC_API_KEY=sk-ant-xxx
DASHSCOPE_API_KEY=sk-xxx
LANGSMITH_API_KEY=lsv2_xxx
```

配置文件中引用：

```json
{
  "env": "./.env"
}
```

### 生产部署

生产环境通常在部署平台配置环境变量，而不是使用 `.env` 文件。

## 完整示例

### 目录结构

```
my-chatbot/
├── my_chatbot/
│   ├── __init__.py
│   ├── agent.py
│   ├── tools.py
│   └── prompts.py
├── .env
├── requirements.txt
└── langgraph.json
```

### agent.py

```python
from langgraph.graph import StateGraph, MessagesState, START
from langchain.chat_models import init_chat_model
from .tools import get_tools

def create_agent():
    model = init_chat_model("gpt-4o-mini")
    tools = get_tools()
    model_with_tools = model.bind_tools(tools)
    
    def call_model(state: MessagesState):
        response = model_with_tools.invoke(state["messages"])
        return {"messages": [response]}
    
    builder = StateGraph(MessagesState)
    builder.add_node("agent", call_model)
    builder.add_edge(START, "agent")
    
    return builder.compile()

# 导出图
graph = create_agent()
```

### langgraph.json

```json
{
  "dependencies": [
    "langchain-openai",
    "langgraph",
    "./my_chatbot"
  ],
  "graphs": {
    "chatbot": "./my_chatbot/agent.py:graph"
  },
  "env": "./.env"
}
```

### requirements.txt

```txt
langgraph>=0.2.0
langchain-openai>=0.1.0
python-dotenv>=1.0.0
```

## 部署要点

| 要点 | 说明 |
|------|------|
| **配置文件位置** | LangGraph CLI 默认使用当前目录的 `langgraph.json` |
| **图名称唯一** | `graphs` 中的键名必须唯一 |
| **依赖完整** | 确保所有运行时依赖都已声明 |
| **环境变量** | 本地用 `.env`，生产在平台配置 |

## 要点总结

- **langgraph.json**：核心配置文件，指定依赖、图、环境变量
- **图路径格式**：`./path/to/file.py:variable_or_function`
- **依赖管理**：支持 PyPI 包和本地包混合
- **多图支持**：一个应用可以包含多个图
- **环境变量**：本地开发用 `.env`，生产在平台配置
