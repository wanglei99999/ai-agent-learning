# æ¶ˆæ¯ç³»ç»Ÿè¯¦è§£ (`core/message.py`)

> ç†è§£ HelloAgents çš„æ¶ˆæ¯å°è£…ä¸ç®¡ç†æœºåˆ¶

---

## ğŸ“š ç›®å½•

- [æ¨¡å—æ¦‚è¿°](#æ¨¡å—æ¦‚è¿°)
- [Message ç±»è¯¦è§£](#message-ç±»è¯¦è§£)
- [æ¶ˆæ¯è§’è‰²è¯´æ˜](#æ¶ˆæ¯è§’è‰²è¯´æ˜)
- [Pydantic åŸºç¡€](#pydantic-åŸºç¡€)
- [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¨¡å—æ¦‚è¿°

### æ–‡ä»¶ä½ç½®
`hello_agents/core/message.py`

### ä¸»è¦åŠŸèƒ½
- å°è£… LLM å¯¹è¯ä¸­çš„æ¶ˆæ¯
- æä¾›ç±»å‹å®‰å…¨çš„æ¶ˆæ¯åˆ›å»º
- æ”¯æŒæ¶ˆæ¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–
- ç®¡ç†æ¶ˆæ¯å…ƒæ•°æ®

### æ ¸å¿ƒç»„ä»¶
- `MessageRole` - æ¶ˆæ¯è§’è‰²ç±»å‹å®šä¹‰
- `Message` - æ¶ˆæ¯ç±»ï¼ˆç»§æ‰¿è‡ª Pydantic BaseModelï¼‰

---

## Message ç±»è¯¦è§£

### å®Œæ•´ä»£ç 

```python
from typing import Optional, Dict, Any, Literal
from datetime import datetime
from pydantic import BaseModel

# å®šä¹‰æ¶ˆæ¯è§’è‰²çš„ç±»å‹ï¼Œé™åˆ¶å…¶å–å€¼ä¸º user/assistant/system/tool å››ç§
MessageRole = Literal["user", "assistant", "system", "tool"]

class Message(BaseModel):
    """
    æ¶ˆæ¯ç±» - ç”¨äºå°è£… LLM å¯¹è¯ä¸­çš„å•æ¡æ¶ˆæ¯
    
    ç»§æ‰¿ Pydantic çš„ BaseModelï¼Œè‡ªåŠ¨è·å¾—ç±»å‹éªŒè¯å’Œåºåˆ—åŒ–èƒ½åŠ›
    """

    content: str                              # æ¶ˆæ¯å†…å®¹
    role: MessageRole                         # æ¶ˆæ¯è§’è‰²ï¼šuser/assistant/system/tool
    timestamp: datetime = None                # æ¶ˆæ¯æ—¶é—´æˆ³
    metadata: Optional[Dict[str, Any]] = None # é¢å¤–å…ƒæ•°æ®ï¼ˆå¯é€‰ï¼‰

    def __init__(self, content: str, role: MessageRole, **kwargs):
        """åˆå§‹åŒ–æ¶ˆæ¯"""
        super().__init__(
            content=content,
            role=role,
            timestamp=kwargs.get('timestamp', datetime.now()),
            metadata=kwargs.get('metadata', {})
        )

    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼ˆOpenAI API æ ¼å¼ï¼‰"""
        return {
            "role": self.role,
            "content": self.content
        }
    
    def __str__(self) -> str:
        """è¿”å›æ¶ˆæ¯çš„å­—ç¬¦ä¸²è¡¨ç¤º"""
        return f"[{self.role}] {self.content}"
```

### ç±»å±æ€§è¯¦è§£

#### 1. content (æ¶ˆæ¯å†…å®¹)

```python
content: str  # å¿…å¡«å­—æ®µ
```

**è¯´æ˜**ï¼š
- æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹
- å¿…å¡«å­—æ®µï¼Œä¸èƒ½ä¸ºç©º
- ç±»å‹ï¼šå­—ç¬¦ä¸²

**ç¤ºä¾‹**ï¼š
```python
content = "è¯·å¸®æˆ‘åˆ†æè¿™æ®µä»£ç "
content = "æˆ‘æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„AIåŠ©æ‰‹"
content = "æœç´¢ç»“æœï¼šæ‰¾åˆ°3æ¡ç›¸å…³ä¿¡æ¯"
```

#### 2. role (æ¶ˆæ¯è§’è‰²)

```python
role: MessageRole  # å¿…å¡«å­—æ®µï¼Œç±»å‹å—é™
```

**ç±»å‹å®šä¹‰**ï¼š
```python
MessageRole = Literal["user", "assistant", "system", "tool"]
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ `Literal` ç±»å‹é™åˆ¶åªèƒ½æ˜¯è¿™4ä¸ªå€¼ä¹‹ä¸€
- ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé˜²æ­¢é”™è¯¯
- IDE ä¼šæä¾›è‡ªåŠ¨è¡¥å…¨

#### 3. timestamp (æ—¶é—´æˆ³)

```python
timestamp: datetime = None  # å¯é€‰å­—æ®µï¼Œæœ‰é»˜è®¤å€¼
```

**è¯´æ˜**ï¼š
- è®°å½•æ¶ˆæ¯åˆ›å»ºæ—¶é—´
- é»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´ `datetime.now()`
- å¯ç”¨äºæ¶ˆæ¯æ’åºã€å†å²å›æº¯

**ç”¨é€”**ï¼š
```python
# æŒ‰æ—¶é—´æ’åºæ¶ˆæ¯
messages.sort(key=lambda m: m.timestamp)

# è¿‡æ»¤ç‰¹å®šæ—¶é—´æ®µçš„æ¶ˆæ¯
recent_messages = [m for m in messages if m.timestamp > cutoff_time]
```

#### 4. metadata (å…ƒæ•°æ®)

```python
metadata: Optional[Dict[str, Any]] = None  # å®Œå…¨å¯é€‰
```

**è¯´æ˜**ï¼š
- å­˜å‚¨é¢å¤–çš„è‡ªå®šä¹‰ä¿¡æ¯
- çµæ´»çš„é”®å€¼å¯¹ç»“æ„
- ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

**ä½¿ç”¨åœºæ™¯**ï¼š
```python
# è®°å½•æ¶ˆæ¯æ¥æº
metadata = {"source": "web_search", "confidence": 0.95}

# è®°å½•å·¥å…·è°ƒç”¨ä¿¡æ¯
metadata = {"tool_name": "calculator", "execution_time": 0.5}

# è®°å½•ç”¨æˆ·ä¿¡æ¯
metadata = {"user_id": "12345", "session_id": "abc"}
```

---

## æ¶ˆæ¯è§’è‰²è¯´æ˜

### 1. user (ç”¨æˆ·æ¶ˆæ¯)

**ç”¨é€”**ï¼šç”¨æˆ·çš„è¾“å…¥æˆ–é—®é¢˜

```python
msg = Message(
    content="ä»€ä¹ˆæ˜¯ ReAct Agentï¼Ÿ",
    role="user"
)
```

**ç‰¹ç‚¹**ï¼š
- å¯¹è¯çš„èµ·ç‚¹
- åŒ…å«ç”¨æˆ·çš„é—®é¢˜ã€æŒ‡ä»¤æˆ–åé¦ˆ
- åœ¨å¯¹è¯å†å²ä¸­æ ‡è¯†ç”¨æˆ·çš„æ„å›¾

### 2. assistant (åŠ©æ‰‹æ¶ˆæ¯)

**ç”¨é€”**ï¼šAI åŠ©æ‰‹çš„å›å¤

```python
msg = Message(
    content="ReAct Agent æ˜¯ä¸€ç§ç»“åˆæ¨ç†å’Œè¡ŒåŠ¨çš„æ™ºèƒ½ä½“...",
    role="assistant"
)
```

**ç‰¹ç‚¹**ï¼š
- LLM ç”Ÿæˆçš„å“åº”
- åŒ…å«ç­”æ¡ˆã€åˆ†ææˆ–å»ºè®®
- åœ¨å¤šè½®å¯¹è¯ä¸­ä¿æŒä¸Šä¸‹æ–‡

### 3. system (ç³»ç»Ÿæ¶ˆæ¯)

**ç”¨é€”**ï¼šå®šä¹‰ AI çš„è§’è‰²å’Œè¡Œä¸º

```python
msg = Message(
    content="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Python ç¼–ç¨‹åŠ©æ‰‹ï¼Œæ“…é•¿ä»£ç åˆ†æå’Œä¼˜åŒ–ã€‚",
    role="system"
)
```

**ç‰¹ç‚¹**ï¼š
- é€šå¸¸æ”¾åœ¨å¯¹è¯å¼€å§‹
- è®¾å®š AI çš„è§’è‰²ã€é£æ ¼ã€çº¦æŸ
- ä¸ä¼šè¢«ç”¨æˆ·ç›´æ¥çœ‹åˆ°
- å¯¹ LLM çš„è¡Œä¸ºæœ‰é‡è¦å½±å“

**System Prompt è®¾è®¡æŠ€å·§**ï¼š
```python
# âœ… å¥½çš„ system prompt
system_msg = Message(
    content="""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥åŠ©æ‰‹ã€‚
    
    ä½ çš„èŒè´£ï¼š
    1. åˆ†æä»£ç è´¨é‡
    2. æŒ‡å‡ºæ½œåœ¨é—®é¢˜
    3. æä¾›æ”¹è¿›å»ºè®®
    
    ä½ çš„é£æ ¼ï¼š
    - ä¸“ä¸šä½†å‹å¥½
    - å…·ä½“ä¸”å¯æ“ä½œ
    - æ³¨é‡æœ€ä½³å®è·µ
    """,
    role="system"
)

# âŒ ä¸å¥½çš„ system prompt
system_msg = Message(
    content="ä½ æ˜¯åŠ©æ‰‹",  # å¤ªç®€å•ï¼Œç¼ºä¹æŒ‡å¯¼
    role="system"
)
```

### 4. tool (å·¥å…·æ¶ˆæ¯)

**ç”¨é€”**ï¼šå·¥å…·æ‰§è¡Œçš„ç»“æœ

```python
msg = Message(
    content="æœç´¢ç»“æœï¼šæ‰¾åˆ°5ç¯‡å…³äº Agent çš„æ–‡ç« ...",
    role="tool",
    metadata={"tool_name": "web_search"}
)
```

**ç‰¹ç‚¹**ï¼š
- è®°å½•å·¥å…·è°ƒç”¨çš„è¾“å‡º
- ä¸º LLM æä¾›å¤–éƒ¨ä¿¡æ¯
- é€šå¸¸é…åˆ ReActã€Function Call ç­‰æ¨¡å¼ä½¿ç”¨

**å·¥å…·æ¶ˆæ¯æµç¨‹**ï¼š
```mermaid
graph LR
    A[ç”¨æˆ·æé—®] --> B[LLM å†³å®šè°ƒç”¨å·¥å…·]
    B --> C[æ‰§è¡Œå·¥å…·]
    C --> D[åˆ›å»º tool æ¶ˆæ¯]
    D --> E[LLM åŸºäºç»“æœå›ç­”]
```

---

## Pydantic åŸºç¡€

### ä¸ºä»€ä¹ˆä½¿ç”¨ Pydanticï¼Ÿ

Message ç±»ç»§æ‰¿è‡ª `pydantic.BaseModel`ï¼Œè¿™å¸¦æ¥äº†å¾ˆå¤šå¥½å¤„ï¼š

#### 1. è‡ªåŠ¨ç±»å‹éªŒè¯

```python
# âœ… æ­£ç¡®ï¼šç±»å‹åŒ¹é…
msg = Message(content="Hello", role="user")

# âŒ é”™è¯¯ï¼šrole ç±»å‹ä¸å¯¹
msg = Message(content="Hello", role="invalid_role")
# æŠ›å‡º ValidationError: role must be one of ['user', 'assistant', 'system', 'tool']

# âŒ é”™è¯¯ï¼šcontent ä¸æ˜¯å­—ç¬¦ä¸²
msg = Message(content=123, role="user")
# æŠ›å‡º ValidationError: content must be a string
```

#### 2. è‡ªåŠ¨åºåˆ—åŒ–

```python
msg = Message(content="Hello", role="user")

# è½¬ä¸ºå­—å…¸
msg_dict = msg.dict()
# {'content': 'Hello', 'role': 'user', 'timestamp': ..., 'metadata': {}}

# è½¬ä¸º JSON
msg_json = msg.json()
# '{"content": "Hello", "role": "user", ...}'
```

#### 3. ä»å­—å…¸åˆ›å»º

```python
data = {
    "content": "Hello",
    "role": "user",
    "timestamp": "2024-01-24T10:00:00"
}

msg = Message(**data)  # è‡ªåŠ¨è§£æå’ŒéªŒè¯
```

#### 4. å­—æ®µé»˜è®¤å€¼

```python
msg = Message(content="Hello", role="user")
# timestamp è‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¶é—´
# metadata è‡ªåŠ¨è®¾ç½®ä¸ºç©ºå­—å…¸ {}
```

### Pydantic æ ¸å¿ƒç‰¹æ€§

```python
from pydantic import BaseModel, Field, validator

class EnhancedMessage(BaseModel):
    content: str = Field(..., min_length=1, max_length=10000)
    role: MessageRole
    importance: float = Field(default=0.5, ge=0.0, le=1.0)
    
    @validator('content')
    def content_not_empty(cls, v):
        if not v.strip():
            raise ValueError('content cannot be empty')
        return v
```

---

## æ ¸å¿ƒæ–¹æ³•è¯¦è§£

### 1. `__init__` åˆå§‹åŒ–æ–¹æ³•

```python
def __init__(self, content: str, role: MessageRole, **kwargs):
    super().__init__(
        content=content,
        role=role,
        timestamp=kwargs.get('timestamp', datetime.now()),
        metadata=kwargs.get('metadata', {})
    )
```

**è®¾è®¡è¦ç‚¹**ï¼š

1. **ç®€åŒ–çš„å‚æ•°åˆ—è¡¨**
   - åªæœ‰ `content` å’Œ `role` æ˜¯å¿…å¡«çš„
   - å…¶ä»–å‚æ•°é€šè¿‡ `**kwargs` ä¼ å…¥

2. **æ™ºèƒ½é»˜è®¤å€¼**
   ```python
   timestamp=kwargs.get('timestamp', datetime.now())  # æœªæä¾›åˆ™ç”¨å½“å‰æ—¶é—´
   metadata=kwargs.get('metadata', {})                # æœªæä¾›åˆ™ç”¨ç©ºå­—å…¸
   ```

3. **è°ƒç”¨çˆ¶ç±»åˆå§‹åŒ–**
   ```python
   super().__init__(...)  # è§¦å‘ Pydantic çš„éªŒè¯é€»è¾‘
   ```

### 2. `to_dict` è½¬æ¢æ–¹æ³•

```python
def to_dict(self) -> Dict[str, Any]:
    """è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼ˆOpenAI API æ ¼å¼ï¼‰"""
    return {
        "role": self.role,
        "content": self.content
    }
```

**ä¸ºä»€ä¹ˆåªè¿”å› role å’Œ contentï¼Ÿ**

è¿™æ˜¯ä¸ºäº†ç¬¦åˆ OpenAI API çš„æ ‡å‡†æ ¼å¼ï¼š

```python
# OpenAI API æœŸæœ›çš„æ¶ˆæ¯æ ¼å¼
messages = [
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "Hello!"},
    {"role": "assistant", "content": "Hi! How can I help you?"}
]

response = client.chat.completions.create(
    model="gpt-3.5-turbo",
    messages=messages  # ç›´æ¥ä½¿ç”¨è¿™ä¸ªæ ¼å¼
)
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```python
# åˆ›å»ºæ¶ˆæ¯åˆ—è¡¨
history = [
    Message("ä½ æ˜¯åŠ©æ‰‹", "system"),
    Message("ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ", "user"),
    Message("Python æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€...", "assistant")
]

# è½¬æ¢ä¸º API æ ¼å¼
api_messages = [msg.to_dict() for msg in history]

# è°ƒç”¨ LLM
response = llm.invoke(api_messages)
```

### 3. `__str__` å­—ç¬¦ä¸²è¡¨ç¤º

```python
def __str__(self) -> str:
    return f"[{self.role}] {self.content}"
```

**ç”¨é€”**ï¼šæ–¹ä¾¿è°ƒè¯•å’Œæ—¥å¿—è¾“å‡º

```python
msg = Message("Hello", "user")
print(msg)  # è¾“å‡º: [user] Hello

# æ‰“å°å¯¹è¯å†å²
for msg in history:
    print(msg)
# [system] ä½ æ˜¯åŠ©æ‰‹
# [user] ä»€ä¹ˆæ˜¯ Pythonï¼Ÿ
# [assistant] Python æ˜¯ä¸€ç§ç¼–ç¨‹è¯­è¨€...
```

---

## å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»ºåŸºç¡€æ¶ˆæ¯

```python
from hello_agents.core.message import Message

# ç”¨æˆ·æ¶ˆæ¯
user_msg = Message(
    content="è¯·å¸®æˆ‘åˆ†æè¿™æ®µä»£ç ",
    role="user"
)

# ç³»ç»Ÿæ¶ˆæ¯
system_msg = Message(
    content="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®¡æŸ¥åŠ©æ‰‹",
    role="system"
)

# åŠ©æ‰‹æ¶ˆæ¯
assistant_msg = Message(
    content="å¥½çš„ï¼Œè¯·æä¾›ä»£ç ",
    role="assistant"
)
```

### ç¤ºä¾‹ 2: å¸¦å…ƒæ•°æ®çš„æ¶ˆæ¯

```python
# è®°å½•å·¥å…·è°ƒç”¨
tool_msg = Message(
    content="æœç´¢ç»“æœï¼šæ‰¾åˆ°3ç¯‡ç›¸å…³æ–‡ç« ",
    role="tool",
    metadata={
        "tool_name": "web_search",
        "query": "Python Agent",
        "results_count": 3,
        "execution_time": 1.5
    }
)

# è®¿é—®å…ƒæ•°æ®
print(tool_msg.metadata["tool_name"])  # web_search
```

### ç¤ºä¾‹ 3: æ„å»ºå¯¹è¯å†å²

```python
from hello_agents.core.message import Message

class ConversationManager:
    def __init__(self, system_prompt: str):
        self.history = []
        # æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        self.add_message(Message(system_prompt, "system"))
    
    def add_user_message(self, content: str):
        self.add_message(Message(content, "user"))
    
    def add_assistant_message(self, content: str):
        self.add_message(Message(content, "assistant"))
    
    def add_message(self, message: Message):
        self.history.append(message)
    
    def get_api_messages(self):
        """è·å– API æ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨"""
        return [msg.to_dict() for msg in self.history]
    
    def print_history(self):
        """æ‰“å°å¯¹è¯å†å²"""
        for msg in self.history:
            print(msg)

# ä½¿ç”¨
conv = ConversationManager("ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹")
conv.add_user_message("ä»€ä¹ˆæ˜¯ Agentï¼Ÿ")
conv.add_assistant_message("Agent æ˜¯ä¸€ç§æ™ºèƒ½ä½“...")
conv.add_user_message("èƒ½ä¸¾ä¸ªä¾‹å­å—ï¼Ÿ")

conv.print_history()
# [system] ä½ æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„åŠ©æ‰‹
# [user] ä»€ä¹ˆæ˜¯ Agentï¼Ÿ
# [assistant] Agent æ˜¯ä¸€ç§æ™ºèƒ½ä½“...
# [user] èƒ½ä¸¾ä¸ªä¾‹å­å—ï¼Ÿ
```

### ç¤ºä¾‹ 4: æ¶ˆæ¯è¿‡æ»¤å’Œå¤„ç†

```python
from datetime import datetime, timedelta

# è¿‡æ»¤æœ€è¿‘çš„æ¶ˆæ¯
def get_recent_messages(messages: list[Message], hours: int = 1):
    cutoff = datetime.now() - timedelta(hours=hours)
    return [msg for msg in messages if msg.timestamp > cutoff]

# åªè·å–ç”¨æˆ·æ¶ˆæ¯
def get_user_messages(messages: list[Message]):
    return [msg for msg in messages if msg.role == "user"]

# ç»Ÿè®¡æ¶ˆæ¯æ•°é‡
def count_by_role(messages: list[Message]):
    counts = {}
    for msg in messages:
        counts[msg.role] = counts.get(msg.role, 0) + 1
    return counts

# ä½¿ç”¨
history = [
    Message("ç³»ç»Ÿæç¤º", "system"),
    Message("é—®é¢˜1", "user"),
    Message("å›ç­”1", "assistant"),
    Message("é—®é¢˜2", "user"),
]

print(count_by_role(history))
# {'system': 1, 'user': 2, 'assistant': 1}
```

### ç¤ºä¾‹ 5: æ¶ˆæ¯åºåˆ—åŒ–

```python
import json

# ä¿å­˜å¯¹è¯å†å²
def save_conversation(messages: list[Message], filename: str):
    data = [msg.dict() for msg in messages]
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2, default=str)

# åŠ è½½å¯¹è¯å†å²
def load_conversation(filename: str) -> list[Message]:
    with open(filename, 'r', encoding='utf-8') as f:
        data = json.load(f)
    return [Message(**item) for item in data]

# ä½¿ç”¨
history = [
    Message("ä½ å¥½", "user"),
    Message("ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ", "assistant")
]

save_conversation(history, "conversation.json")
loaded_history = load_conversation("conversation.json")
```

---

## æœ€ä½³å®è·µ

### 1. System Prompt è®¾è®¡

```python
# âœ… æ¨èï¼šç»“æ„åŒ–çš„ system prompt
system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ Python ç¼–ç¨‹åŠ©æ‰‹ã€‚

ä½ çš„èƒ½åŠ›ï¼š
- ä»£ç åˆ†æå’Œå®¡æŸ¥
- Bug è¯Šæ–­å’Œä¿®å¤
- æ€§èƒ½ä¼˜åŒ–å»ºè®®
- æœ€ä½³å®è·µæŒ‡å¯¼

ä½ çš„é£æ ¼ï¼š
- ä¸“ä¸šä½†æ˜“æ‡‚
- æä¾›å…·ä½“ç¤ºä¾‹
- è§£é‡ŠåŸç†å’ŒåŸå› 

é™åˆ¶ï¼š
- ä¸ç¼–å†™æ¶æ„ä»£ç 
- ä¸æä¾›è¿‡æ—¶çš„æ–¹æ¡ˆ
- æ‰¿è®¤ä¸ç¡®å®šçš„åœ°æ–¹
"""

msg = Message(system_prompt, "system")
```

### 2. æ¶ˆæ¯å†å²ç®¡ç†

```python
class MessageHistory:
    def __init__(self, max_length: int = 100):
        self.messages = []
        self.max_length = max_length
    
    def add(self, message: Message):
        self.messages.append(message)
        # ä¿æŒå†å²é•¿åº¦é™åˆ¶
        if len(self.messages) > self.max_length:
            # ä¿ç•™ system æ¶ˆæ¯ï¼Œåˆ é™¤æœ€æ—§çš„å¯¹è¯
            system_msgs = [m for m in self.messages if m.role == "system"]
            other_msgs = [m for m in self.messages if m.role != "system"]
            self.messages = system_msgs + other_msgs[-self.max_length:]
    
    def get_for_api(self):
        return [msg.to_dict() for msg in self.messages]
```

### 3. å…ƒæ•°æ®çš„æœ‰æ•ˆä½¿ç”¨

```python
# è®°å½•è¯¦ç»†çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
tool_msg = Message(
    content=search_results,
    role="tool",
    metadata={
        "tool_name": "web_search",
        "query": query,
        "source": "google",
        "results_count": len(results),
        "execution_time": elapsed_time,
        "success": True
    }
)

# åç»­å¯ä»¥åˆ†æå·¥å…·ä½¿ç”¨æƒ…å†µ
def analyze_tool_usage(messages: list[Message]):
    tool_msgs = [m for m in messages if m.role == "tool"]
    for msg in tool_msgs:
        print(f"å·¥å…·: {msg.metadata.get('tool_name')}")
        print(f"è€—æ—¶: {msg.metadata.get('execution_time')}s")
```

### 4. ç±»å‹å®‰å…¨

```python
from typing import List

def process_messages(messages: List[Message]) -> List[dict]:
    """ç±»å‹æ³¨è§£ç¡®ä¿ä¼ å…¥çš„æ˜¯ Message å¯¹è±¡åˆ—è¡¨"""
    return [msg.to_dict() for msg in messages]

# IDE ä¼šæä¾›ç±»å‹æ£€æŸ¥å’Œè‡ªåŠ¨è¡¥å…¨
messages: List[Message] = [
    Message("Hello", "user"),
    Message("Hi", "assistant")
]
```

---

## å­¦ä¹ æ£€æŸ¥æ¸…å•

### åŸºç¡€ç†è§£
- [ ] ç†è§£ Message ç±»çš„å››ä¸ªæ ¸å¿ƒå±æ€§
- [ ] æŒæ¡å››ç§æ¶ˆæ¯è§’è‰²çš„ç”¨é€”
- [ ] äº†è§£ Pydantic BaseModel çš„ä¼˜åŠ¿
- [ ] èƒ½å¤Ÿåˆ›å»ºå’Œä½¿ç”¨åŸºç¡€æ¶ˆæ¯

### è¿›é˜¶æŒæ¡
- [ ] ç†è§£ to_dict() æ–¹æ³•çš„è®¾è®¡åŸå› 
- [ ] æŒæ¡å…ƒæ•°æ®çš„ä½¿ç”¨åœºæ™¯
- [ ] èƒ½å¤Ÿè®¾è®¡æœ‰æ•ˆçš„ system prompt
- [ ] ç†è§£æ¶ˆæ¯å†å²çš„ç®¡ç†ç­–ç•¥

### å®æˆ˜åº”ç”¨
- [ ] å®ç°ä¸€ä¸ªå¯¹è¯å†å²ç®¡ç†å™¨
- [ ] è®¾è®¡é’ˆå¯¹ç‰¹å®šåœºæ™¯çš„ system prompt
- [ ] ä½¿ç”¨å…ƒæ•°æ®è®°å½•å·¥å…·è°ƒç”¨ä¿¡æ¯
- [ ] å®ç°æ¶ˆæ¯çš„æŒä¹…åŒ–å’ŒåŠ è½½

---

**ä¸‹ä¸€æ­¥å­¦ä¹ **: [Agent åŸºç±»è¯¦è§£](./03_AgentåŸºç±»è¯¦è§£.md)
